<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Lab Node</title>
    <link rel="manifest" href="/static/manifest.json">
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status {
            font-weight: bold;
            color: #666;
        }

        .status.connected {
            color: green;
        }

        .status.disconnected {
            color: red;
        }

        #log {
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>LLM Lab Worker</h1>
        <p>Status: <span id="status" class="status">Disconnected</span></p>
        <p>Node ID: <span id="nodeId">Generating...</span></p>
        <p>Device: <span id="deviceInfo">...</span></p>
        <p>Task: <span id="currentTask" style="color:#007bff; font-weight:bold;">Idle</span></p>
        <button id="wakeBtn" onclick="toggleWakeLock()">Enable Wake Lock ‚òÄÔ∏è</button>
        <button onclick="clearLogs()" style="background:#dc3545;">Clear Logs</button>
    </div>
    <div id="log"></div>

    <script>
        let wakeLock = null;
        async function toggleWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
                document.getElementById('wakeBtn').textContent = 'Enable Wake Lock ‚òÄÔ∏è';
                log('Wake Lock released');
                return;
            }
            await requestWakeLock();
        }

        async function requestWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                document.getElementById('wakeBtn').textContent = 'Disable Wake Lock üåô';
                log('Wake Lock active');
                wakeLock.addEventListener('release', () => {
                    log('Wake Lock released by system');
                    // Don't nullify immediately if we want to auto-reacquire, 
                    // but usually system release means we lost it.
                    wakeLock = null;
                    document.getElementById('wakeBtn').textContent = 'Enable Wake Lock ‚òÄÔ∏è';
                });
            } catch (err) {
                log(`Wake Lock failed: ${err.name}, ${err.message}`);
            }
        }

        // Auto-reacquire on visibility change
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });
        let nodeId = localStorage.getItem('llm_node_id');
        if (!nodeId) {
            function uuidv4() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            nodeId = uuidv4();
            localStorage.setItem('llm_node_id', nodeId);
        }

        document.getElementById('nodeId').textContent = nodeId;
        document.getElementById('deviceInfo').textContent = navigator.userAgent;

        // Metrics
        let bytesSent = 0;

        const logDiv = document.getElementById('log');

        // Load logs from storage
        const storedLogs = JSON.parse(localStorage.getItem('llm_logs') || '[]');
        storedLogs.forEach(entry => {
            const div = document.createElement('div');
            div.textContent = entry;
            logDiv.prepend(div);
        });

        function log(msg) {
            const timestamped = `[${new Date().toLocaleTimeString()}] ${msg}`;
            const div = document.createElement('div');
            div.textContent = timestamped;
            logDiv.prepend(div);

            // Persist (keep last 50)
            const logs = JSON.parse(localStorage.getItem('llm_logs') || '[]');
            logs.push(timestamped);
            if (logs.length > 50) logs.shift();
            localStorage.setItem('llm_logs', JSON.stringify(logs));
        }

        function clearLogs() {
            localStorage.setItem('llm_logs', '[]');
            logDiv.innerHTML = '';
        }

        // Initialize Compute Worker
        const computeWorker = new Worker('worker.js');
        let activeWs = null;

        // Handle Worker Results
        computeWorker.onmessage = (e) => {
            const { task_id, status, response, error } = e.data;
            log(`Task ${task_id} completed: ${status}`);

            if (activeWs && activeWs.readyState === WebSocket.OPEN) {
                const resultMsg = {
                    node_id: nodeId, // send node_id so coordinator knows who did it
                    task_id: task_id,
                    status: status,
                    response: response,
                    error: error,
                    timestamp: Date.now() / 1000
                };
                activeWs.send(JSON.stringify(resultMsg));
                log(`Result sent for ${task_id}`);
            } else {
                log(`Error: WS not open, cannot send result for ${task_id}`);
            }
        };

        function connect() {
            const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${proto}//${window.location.host}/ws/join`;

            log(`Connecting to ${wsUrl}...`);
            const ws = new WebSocket(wsUrl);
            activeWs = ws;

            ws.onopen = () => {
                document.getElementById('status').textContent = 'Connected (Compute Node)';
                document.getElementById('status').className = 'status connected';
                log('WebSocket Connected - Ready for Tasks');

                // Send handshake / initial heartbeat with extended capabilities
                const msg = {
                    type: "heartbeat",
                    node_id: nodeId,
                    capabilities: ["web_worker", "browser_tool", "javascript_execution"],
                    model: "web_slm",
                    timestamp: Date.now() / 1000,
                    data_stats: { sent_bytes: bytesSent }
                };
                const msgStr = JSON.stringify(msg);
                bytesSent += new TextEncoder().encode(msgStr).length;
                ws.send(msgStr);

                // Start heartbeat loop
                setInterval(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        msg.timestamp = Date.now() / 1000;
                        msg.data_stats = { sent_bytes: bytesSent };
                        const hbStr = JSON.stringify(msg);
                        bytesSent += new TextEncoder().encode(hbStr).length;
                        ws.send(hbStr);
                    }
                }, 5000);
            };

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'execute_task') {
                        log(`‚ö° Received Task: ${msg.task_id}`);
                        // Forward to Worker
                        computeWorker.postMessage({
                            task_id: msg.task_id,
                            code: msg.code
                        });
                    } else {
                        // log(`Received: ${event.data}`); // Reduce spam
                    }
                } catch (e) {
                    log(`Error parsing message: ${e}`);
                }
            };

            ws.onclose = () => {
                document.getElementById('status').textContent = 'Disconnected';
                document.getElementById('status').className = 'status disconnected';
                activeWs = null;
                log('Disconnected. Retrying in 3s...');
                setTimeout(connect, 3000);
            };

            ws.onerror = (err) => {
                console.error("WS Error", err);
                ws.close();
            };
        }

        connect();
    </script>
</body>

</html>